<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Client (Phase 2)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #messages { border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 5px; margin-top: 10px; }
    input, button { margin: 5px; padding: 5px; }
    .system { color: gray; }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>🔐 Chat Client</h2>
  <p>
    1. Register/Login → get JWT token <br>
    2. Paste it below → connect to a room <br>
    3. Chat in real-time 🎉
  </p>

  <label>Room:</label>
  <input id="room" value="general"><br>

  <label>JWT Token:</label>
  <input id="token" size="50" placeholder="Paste your token here"><br>

  <button onclick="connect()">Connect</button>
  <button onclick="disconnect()">Disconnect</button><br>

  <label>Message:</label>
  <input id="messageInput" size="40" placeholder="Type a message">
  <button onclick="sendMessage()">Send</button>

  <div id="messages"></div>

  <script>
    let ws;
    const messagesDiv = document.getElementById("messages");

    function getWsUrl(room, token) {
      // Determine protocol (ws for local, wss for deployed)
      let protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
      let host = window.location.host; // domain + port if any
      return `${protocol}${host}/ws/${room}?token=${token}`;
    }

    function logMessage(msg, cls="") {
      let p = document.createElement("p");
      if (cls) p.className = cls;
      p.textContent = msg;
      messagesDiv.appendChild(p);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function connect() {
      const room = document.getElementById("room").value;
      const token = document.getElementById("token").value;

      if (!token) {
        logMessage("[error] Token is required!", "error");
        return;
      }

      const wsUrl = getWsUrl(room, token);
      logMessage(`[system] Connecting to ${wsUrl}`, "system");

      ws = new WebSocket(wsUrl);

      ws.onopen = () => logMessage("[system] Connected ✅", "system");
      ws.onmessage = (event) => logMessage(event.data);
      ws.onclose = () => logMessage("[system] Disconnected ❌", "system");
      ws.onerror = (err) => logMessage("[error] WebSocket error", "error");
    }

    function disconnect() {
      if (ws) ws.close();
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(input.value);
        input.value = "";
      } else {
        logMessage("[error] Not connected", "error");
      }
    }
  </script>
</body>
</html>
